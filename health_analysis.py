import pandas as pd
import numpy as np
import plotly.express as px
from sklearn.decomposition import PCA
from sklearn.preprocessing import MinMaxScaler
import folium

# Sample data (Replace with real data in practice)
data = {
    "region": ["Region A", "Region B", "Region C", "Region D"],
    "latitude": [34.0522, 36.1699, 40.7128, 25.7617],
    "longitude": [-118.2437, -115.1398, -74.0060, -80.1918],
    "avg_temperature": [35, 30, 28, 40],     # Average temperature in Celsius
    "air_quality_index": [150, 85, 100, 200], # AQI, where higher is worse
    "water_quality_index": [80, 70, 90, 65],  # WQI, where lower is worse
    "population_density": [1200, 800, 1500, 3000] # Population per sq km
}

# Convert data to DataFrame
df = pd.DataFrame(data)

# Normalize factors for fair comparison using MinMaxScaler
scaler = MinMaxScaler()
normalized_data = scaler.fit_transform(df[['avg_temperature', 'air_quality_index', 'water_quality_index', 'population_density']])
df[['temp_normalized', 'air_quality_normalized', 'water_quality_normalized', 'pop_density_normalized']] = normalized_data

# Apply PCA to determine weights based on variance explained by each factor
pca = PCA(n_components=1)
df['hvi_score'] = pca.fit_transform(normalized_data)
explained_variance = pca.explained_variance_ratio_[0]
print(f"PCA Explained Variance for Health Vulnerability Index: {explained_variance:.2f}")

# Scale HVI to [0, 1] for interpretability
df['health_vulnerability_index'] = MinMaxScaler().fit_transform(df[['hvi_score']])

# Categorize risk levels
def categorize_risk(index):
    if index >= 0.7:
        return "High"
    elif index >= 0.4:
        return "Moderate"
    else:
        return "Low"

df['risk_level'] = df['health_vulnerability_index'].apply(categorize_risk)

# Display HVI DataFrame
print("\nHealth Vulnerability Index (HVI) and Risk Levels for each region:")
print(df[['region', 'health_vulnerability_index', 'risk_level']])

# Visualization: Bar chart with Plotly
fig = px.bar(df, x='region', y='health_vulnerability_index', color='risk_level',
             title="Health Vulnerability Index by Region with Risk Categories",
             labels={'health_vulnerability_index': 'HVI (0-1 Scale)'})
fig.update_layout(xaxis_title="Region", yaxis_title="Health Vulnerability Index")
fig.show()

# Mapping: Display HVI on an interactive map with Folium
map_center = [df['latitude'].mean(), df['longitude'].mean()]
hvi_map = folium.Map(location=map_center, zoom_start=6)

for _, row in df.iterrows():
    popup_text = f"Region: {row['region']}<br>HVI: {row['health_vulnerability_index']:.2f}<br>Risk Level: {row['risk_level']}"
    color = "red" if row['risk_level'] == "High" else "orange" if row['risk_level'] == "Moderate" else "green"
    folium.CircleMarker(
        location=[row['latitude'], row['longitude']],
        radius=8,
        color=color,
        fill=True,
        fill_color=color,
        fill_opacity=0.7,
        popup=popup_text
    ).add_to(hvi_map)

# Save the map to an HTML file
hvi_map.save("health_vulnerability_map.html")
print("Interactive map saved as 'health_vulnerability_map.html'. Open this file in a browser to view the map.")
